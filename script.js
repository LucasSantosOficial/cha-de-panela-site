// Dados dos presentes
// let presents = [
//   {
//     id: 1,
//     name: "1 ano de academia para os noivos",
//     value: "R$ 30,00",
//     status: "available",
//     icon: "üèãÔ∏è",
//   },
//   {
//     id: 2,
//     name: "Aulas de culin√°ria para casais",
//     value: "R$ 40,00",
//     status: "available",
//     icon: "üç≥",
//   },
//   {
//     id: 3,
//     name: "Massagem relaxante para dois",
//     value: "R$ 50,00",
//     status: "available",
//     icon: "üíÜ",
//   },
//   {
//     id: 4,
//     name: "Jantar rom√¢ntico em casa",
//     value: "R$ 60,00",
//     status: "available",
//     icon: "üç∑",
//   },
//   {
//     id: 5,
//     name: "Kit sobreviv√™ncia para rec√©m-casados",
//     value: "R$ 70,00",
//     status: "available",
//     icon: "üéí",
//   },
//   {
//     id: 6,
//     name: "Curso de dan√ßa para noivos",
//     value: "R$ 80,00",
//     status: "available",
//     icon: "üíÉ",
//   },
//   {
//     id: 7,
//     name: "Sertralina simb√≥lica para manter a paz conjugal",
//     value: "R$ 90,00",
//     status: "available",
//     icon: "üíä",
//   },
//   {
//     id: 8,
//     name: "Spray anti-p√©-frio para noites de cobertor",
//     value: "R$ 100,00",
//     status: "available",
//     icon: "üß¶",
//   },
//   {
//     id: 9,
//     name: "Vale 'pode escolher o filme hoje'",
//     value: "R$ 110,00",
//     status: "available",
//     icon: "üé•",
//   },
//   {
//     id: 10,
//     name: "Kit 'sorria e acene' para momentos tensos",
//     value: "R$ 120,00",
//     status: "available",
//     icon: "üß∏",
//   },
//   {
//     id: 11,
//     name: "Curso de como elogiar a comida sem mentir",
//     value: "R$ 130,00",
//     status: "available",
//     icon: "üçù",
//   },
//   {
//     id: 12,
//     name: "Vale 'dia sem perguntas dif√≠ceis'",
//     value: "R$ 140,00",
//     status: "available",
//     icon: "ü§ê",
//   },
//   {
//     id: 13,
//     name: "Kit de emerg√™ncia para visitas inesperadas",
//     value: "R$ 150,00",
//     status: "available",
//     icon: "üö™",
//   },
//   {
//     id: 14,
//     name: "Curso de como dividir o edredom",
//     value: "R$ 160,00",
//     status: "available",
//     icon: "üõèÔ∏è",
//   },
//   {
//     id: 15,
//     name: "Vale 'voc√™ estava certo(a)' sem discuss√£o",
//     value: "R$ 170,00",
//     status: "available",
//     icon: "‚úÖ",
//   },
//   {
//     id: 16,
//     name: "Assinatura de elogios di√°rios personalizados",
//     value: "R$ 180,00",
//     status: "available",
//     icon: "üíå",
//   },
//   {
//     id: 17,
//     name: "Curso de como n√£o mexer no celular durante o jantar",
//     value: "R$ 190,00",
//     status: "available",
//     icon: "üìµ",
//   },
//   {
//     id: 18,
//     name: "Vale 'sem perguntas durante futebol'",
//     value: "R$ 200,00",
//     status: "available",
//     icon: "‚öΩ",
//   },
//   {
//     id: 19,
//     name: "Kit de desculpas criativas para esquecer o lixo",
//     value: "R$ 210,00",
//     status: "available",
//     icon: "üóëÔ∏è",
//   },
//   {
//     id: 20,
//     name: "Curso de como fingir interesse em s√©ries alheias",
//     value: "R$ 220,00",
//     status: "available",
//     icon: "üé¨",
//   },
//   {
//     id: 21,
//     name: "Manual de como n√£o brigar por besteira",
//     value: "R$ 230,00",
//     status: "available",
//     icon: "üìò",
//   },
//   {
//     id: 22,
//     name: "Almofada com bot√£o de desculpas autom√°ticas",
//     value: "R$ 240,00",
//     status: "available",
//     icon: "üõãÔ∏è",
//   },
//   {
//     id: 23,
//     name: "Curso intensivo de 'quem lava a lou√ßa hoje'",
//     value: "R$ 250,00",
//     status: "available",
//     icon: "üçΩÔ∏è",
//   },
//   {
//     id: 24,
//     name: "Vale noite sem ronco",
//     value: "R$ 260,00",
//     status: "available",
//     icon: "üò¥",
//   },
//   {
//     id: 25,
//     name: "Kit de sobreviv√™ncia em compras no shopping",
//     value: "R$ 270,00",
//     status: "available",
//     icon: "üõçÔ∏è",
//   },
//   {
//     id: 26,
//     name: "Curso de como elogiar sem parecer for√ßado",
//     value: "R$ 280,00",
//     status: "available",
//     icon: "üó£Ô∏è",
//   },
//   {
//     id: 27,
//     name: "Jogo de tabuleiro 'Quem manda aqui?'",
//     value: "R$ 290,00",
//     status: "available",
//     icon: "üé≤",
//   },
//   {
//     id: 28,
//     name: "Vale 'dia do sof√° e s√©rie sem culpa'",
//     value: "R$ 300,00",
//     status: "available",
//     icon: "üì∫",
//   },
//   {
//     id: 29,
//     name: "√ìculos de realidade virtual para fugir de DRs",
//     value: "R$ 400,00",
//     status: "available",
//     icon: "üï∂Ô∏è",
//   },
//   {
//     id: 30,
//     name: "Jetpack para escapar de tarefas dom√©sticas",
//     value: "R$ 500,00",
//     status: "available",
//     icon: "üöÄ",
//   },

//   {
//     id: 31,
//     name: "Agenda para n√£o esquecer datas importantes para o noivo",
//     value: "R$ 900,00",
//     status: "available",
//     icon: "üìí",
//   },
//   {
//     id: 32,
//     name: "Drone personalizado para vigiar o noivo no futebol",
//     value: "R$ 1.000,00",
//     status: "available",
//     icon: "üõ∏",
//   },
//   {
//     id: 33,
//     name: "Rob√¥ aspirador com sensor de ci√∫mes",
//     value: "R$ 1.500,00",
//     status: "available",
//     icon: "ü§ñ",
//   },
//   {
//     id: 34,
//     name: "Assinatura vital√≠cia de sorvete gourmet para crises da noiva",
//     value: "R$ 2.000,00",
//     status: "available",
//     icon: "üç®",
//   },

//   {
//     id: 35,
//     name: "Parcela simb√≥lica da Ferrari do noivo",
//     value: "R$ 2.500,00",
//     status: "available",
//     icon: "üèéÔ∏è",
//   },
//   {
//     id: 36,
//     name: "Viagem de autoconhecimento da noiva pro Canad√°",
//     value: "R$ 3.000,00",
//     status: "available",
//     icon: "üõ´",
//   },
// ];


async function buscarDados() {
  console.log("aquiiiiiiiiii");
  try {
    const response = await fetch('https://webhooks.coraxy.com.br/webhook/estoque');
    if (!response.ok) {
      throw new Error("Deu erro!");
    }

    const data = await response.json();
    console.log('Resultado:', data);
    return data;
  } catch (error) {
    console.error('Falha na requisi√ß√£o:', error);
  }
}

let presents;

// ==============================
// ‚öôÔ∏è FUN√á√ïES DE STATUS E RENDERIZA√á√ÉO
// ==============================
function getButtonClass(valorEmEstoque) {
  if (valorEmEstoque > 0) return "button-available";
  // if (valorEmEstoque === "selected") return "button-selected";
  if (valorEmEstoque === 0) return "button-given";
}

function getButtonText(valorEmEstoque) {
  if (valorEmEstoque > 0) return "Presentear";
  // if (valorEmEstoque === "selected") return "Desmarcar";
  if (valorEmEstoque === 0) return "J√° Presenteado";
}

function renderPresents() {
  const grid = document.getElementById("presents-grid");
  grid.innerHTML = "";

  presents.forEach((present) => {
    const card = document.createElement("div");
    card.classList.add("present-card");

    const isGiven = present.estoque === 0; // Agora √© true se acabou o estoque
    const button = document.createElement("button");

    if (isGiven) {
      button.disabled = true;
    } else {
      button.onclick = () => handlePresentClick(present.id);
    }

    const statusClass = present.status;
    const statusText = isGiven
      ? "Presenteado"
      : present.status === "selected"
      ? "Selecionado"
      : "Dispon√≠vel";

    button.classList.add(
      "present-button",
      isGiven
        ? "button-given"
        : present.status === "selected"
        ? "button-selected"
        : "button-available"
    );

    button.textContent = isGiven
      ? "J√° Presenteado"
      : present.status === "selected"
      ? "Selecionado"
      : "Presentear";

    card.innerHTML = `
      <div class="present-icon">${present.icon ?? ""}</div>
      <h3 class="present-title">${present.name ?? "Sem nome"}</h3>
      <p class="present-price">${present.value ?? ""}</p>
      <p class="present-status status-${statusClass}">${statusText}</p>
    `;

    card.appendChild(button);
    grid.appendChild(card);
  });
}


function handlePresentClick(id) {
  const p = presents.find((x) => x.id === id);
  if (!p) return;

  // p.status = p.status === "available" ? "selected" : "available";
  p.status = "selected";
  renderPresents();

  if (p.status === "selected") {document.getElementById("pix-section").scrollIntoView({ behavior: "smooth" });
  }
}

// ==============================
// üí≥ PIX COPY
// ==============================
const pixKey = "47745213886";
function copyPixKey() {
  const button = document.getElementById("copy-button");
  const copyText = button.querySelector(".copy-text");
  const copyIcon = button.querySelector(".copy-icon");

  navigator.clipboard.writeText(pixKey).then(() => {
    button.classList.add("copied");
    copyText.textContent = "Copiado!";
    copyIcon.textContent = "‚úÖ";
    setTimeout(() => {
      button.classList.remove("copied");
      copyText.textContent = "Copiar chave PIX";
      copyIcon.textContent = "üìã";
    }, 2000);
  });
}

// ==============================
// üíå ENVIO DO FORMUL√ÅRIO (EMAIL)
// ==============================
async function sendDonation(e) {
  e.preventDefault();

  // ‚úÖ Verifica se o presente foi selecionado
  if (!selectedGift) {
    alert("Por favor, selecione um presente antes de enviar.");
    return;
  }

  const form = e.target;
  const submitBtn = form.querySelector("button[type='submit']");
  const formData = new FormData(form);
  formData.append("giftId", selectedGift.id);
  formData.append("giftName", selectedGift.name);

  submitBtn.disabled = true;
  const original = submitBtn.textContent;
  submitBtn.textContent = "Enviando...";

  try {
    // üîπ Envia o comprovante e dados da doa√ß√£o
    const response = await fetch("https://webhooks.coraxy.com.br/webhook/comprovante", {
      method: "POST",
      body: formData,
    });

    const data = await response.json().catch(() => ({}));

    if (response.ok) {
      alert("üíñ Contribui√ß√£o enviada com sucesso! Muito obrigado!");

      // // üî• Remove 1 unidade do presente no banco de dados via N8N
      // await fetch("https://webhooks.coraxy.com.br/webhook/deletar", {
      //   method: "POST",
      //   headers: { "Content-Type": "application/json" },
      //   body: JSON.stringify({
      //     id_presente: selectedGift.id,
      //   }),
      // });

      // üõçÔ∏è Marca o presente como "Presenteado" visualmente
      selectedGift.status = "given";
      renderPresents();
      selectedGift = null;

      // üîÑ Limpa o formul√°rio
      form.reset();
    } else {
      alert("‚ö†Ô∏è Ocorreu um erro ao enviar. Tente novamente em alguns minutos.");
    }
  } catch (err) {
    console.error("Erro ao enviar:", err);
    alert("‚ùå Erro ao enviar. Verifique sua conex√£o e tente novamente.");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = original;
  }
}


// ==============================
// üéµ ANIMA√á√ïES E PLAYER
// ==============================
document.addEventListener("DOMContentLoaded", async() => {
  
  presents = await buscarDados();

  renderPresents();
  

  const copyButton = document.getElementById("copy-button");
  if (copyButton) copyButton.addEventListener("click", copyPixKey);

  const form = document.getElementById("doacao-form");
  if (form) form.addEventListener("submit", sendDonation);

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = "1";
          entry.target.style.transform = "translateY(0)";
        }
      });
    },
    { threshold: 0.1, rootMargin: "0px 0px -50px 0px" }
  );

  const animated = document.querySelectorAll(
    ".intro-card, .present-card, .pix-card"
  );
  animated.forEach((el) => {
    el.style.opacity = "0";
    el.style.transform = "translateY(20px)";
    el.style.transition = "opacity 0.6s ease, transform 0.6s ease";
    observer.observe(el);
  });

  // Player de m√∫sica
  const player = document.getElementById("player");
  const source = document.createElement("source");
  source.src = "tapasebeijos.mp3";
  source.type = "audio/mpeg";
  player.appendChild(source);

  document.body.addEventListener(
    "click",
    () => {
      player.load();
      player.play();
    },
    { once: true }
  );
});

let selectedGift = null;

function handlePresentClick(id) {
  const p = presents.find((x) => x.id === id);
  if (!p) return;

  // Alterna o status
  if (p.status === "available") {
    // Marca como selecionado
    if (selectedGift) selectedGift.status = "available"; // desmarca o anterior
    p.status = "selected";
    selectedGift = p;
    document
      .getElementById("pix-section")
      .scrollIntoView({ behavior: "smooth" });
  } else if (p.status === "selected") {
    // Desmarca
    p.status = "available";
    selectedGift = null;
  }

  renderPresents();
}
